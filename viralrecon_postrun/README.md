## Viralrecon postrun script

The viralrecon postrun script produces a summary output file containing other informative output metrics in addition to the output metrics generated by [nf-core viralrecon](https://github.com/nf-core/viralrecon). The viralrecon postrun script is run as a [Nextflow Tower](https://tower.nf/) post-run script that automatically runs after the completion of viralrecon run over Nextflow Tower. The script was tested on viralrecon versions 2.4.1 and 2.5.

### Requirements

The requirements to run the viralrecon postrun script on Nextflow Tower are as follows:

+ **Monochrome logs** must be toggled to ON in the 'Generic options' table when entering launch settings and parameters. Stripping text of the ANSI color codes has not yet been implemented.

+ A bash script that installs the dependencies needed for the script (eg. pysam, pandas, boto3, etc.) and runs the python script. This bash script gets copied into the Nextflow Tower post-run environment and is required mostly because of character limits in the post-run script field on Nextflow Tower.

### Running the viralrecon postrun script

The viralrecon postrun script is simply a python script that appends additional data metrics to the viralrecon output file ```summary_variants_metrics_mqc.csv```. This python script, as well as the bash script that installs the dependecies in the post-run environment and runs the python script, are copied from an AWS S3 bucket to the post-run environment using commands from the [AWS CLI](https://aws.amazon.com/cli/). It is important to know the S3 bucket URI where these scripts are and change the URI accordingly.


1. Choose the viralrecon workflow in the Nextflow Tower launchpad.
2. Select/enter in all desired parameters.
3. Click on "Show hidden params" on the sidebar and in "Generic options", toggle 'monochrome_logs' to ON.
4. On the same sidebar, click on "Launch settings".
5. In 'Advanced options' in the 'Post-run script' field, enter the following:
```
        echo "--- Starting post-run script ---"

        pr_copy_cmd="aws s3 cp s3://dev-wslh-sequencing-analyses/scripts/viralrecon_wrapper_postrun.sh ."
        echo "Copying bash script to post-run environment with command: '$pr_copy_cmd'.."
        $pr_copy_cmd

        run_script="bash viralrecon_wrapper_postrun.sh"
        echo "Running post-run script with command: '$run_script'"
        $run_script
```
6. Launch the workflow by clicking "Launch".

### Output

The output of the script is a csv file: ```viralrecon_wrapper_report.csv```. It is the ```summary_variants_metrics_mqc.csv``` output file from the viralrecon workflow with additional output metrics as columns appended to the table.


## Authors
Dustin Lyfoung
